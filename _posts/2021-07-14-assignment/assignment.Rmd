---
title: "VAST Challenge 2021 MC2" 
description: |
  User performance analytics based on movement and purchase data.
author:
  - name: Youzhen Zhang
    url: https://example.com/norajones
date: 07-14-2021
output:
  distill::distill_article:
    self_contained: false
    toc: true
    toc_depth: 3
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.retina = 3,
                      echo = TRUE,
                      eval = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

# 1. Introduction

### 1.1 Backgroud of the case

Several employees of GAStech go missing, the case is under investigation.

Many of the Abila, Kronos-based employees of GAStech have company cars which were installed geospatial tracking software to track data periodically as long as they are moving.

This vehicle tracking data has been made available to law enforcement to support their investigation. Unfortunately, data is not available for the day the GAStech employees went missing. Data is only available for the two weeks prior to the disappearance.

Also, Kronos based companies provide a Kronos Kares benefit card to GASTech employees giving them discounts and rewards in exchange for collecting information about their credit card purchases and preferences as recorded on loyalty cards. This data has been made available to investigators in the hopes that it can help resolve the situation.

### 1.2 Objectives of this report

The objectives of this case analysis report is to identify which GASTech employees made which purchases and identify suspicious patterns of behavior. 
During the analysis, 3 aspects were taken into consideration:

1. Using just the credit and loyalty card data, identify the most popular locations, and when they are popular. Also, recommendations should be given to correct these anomalies.

2. Add the vehicle data to analysis of the credit and loyalty card data and figure out the discrepancies between vehicle, credit, and loyalty card data.

3. Infer the owners of each credit card and loyalty card and provide the evidences for that.

# 2. Literature Review

In the literature review conducted, it was found that there were some geospatial data in the dataset. To delivery a clear analysis based on tracking movement trace, I examined how to visualise movement data by using appropriate R packages.

To get a better understanding about the relationship between employee and credit card, some network data visualisation and analysis techniques would be used. For example, build network graph visualisation using appropriate functions of ggraph.

# 3. Data Preperation

### 3.1 Install and load packages

We need to set up the environment and load all required packages first. The code chunk below will install the packages if not yet installed, and load them to the environment.

```{r}
packages = c('ggiraph', 'plotly', 'DT', 'patchwork','plyr',
             'tidyverse','raster', 'sf', 'igraph', 'tidygraph', 
             'ggraph', 'visNetwork', 
             'lubridate', 'clock','tmap','rmarkdown')

for (p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p,character.only = T)
}
```

### 3.2 Import data

The data was loaded using read.csv() of the readr package, which reads delimited files into a tibble.

```{r}
cc_data <- read.csv("MC2/cc_data.csv")
loyalty_data <- read.csv("MC2/loyalty_data.csv")
gps <- read.csv("MC2/gps.csv")
```

### 3.3 Data processing

1. Change variables to the proper data type and create new variables for further analysis. Then show the dataframe to view. 


```{r}
cc_data$timestamp <- date_time_parse(cc_data$timestamp,
                                 zone = "",
                                 format = "%m/%d/%Y %H:%M")

cc_data$date <- substr(cc_data$timestamp,1,10)

cc_data$date <- date_parse(cc_data$date,format = "%Y-%m-%d")


loyalty_data$date <- date_parse(loyalty_data$timestamp,
                                format = "%m/%d/%Y")

glimpse(cc_data)
glimpse(loyalty_data)
```

2. Merge credit card data and loyalty card data into a new data frame to make up the missing transactions in credit card data since the data in credit card data is inconsistent with the data in loyalty card data.

```{r}
joint_cc_loyalty = cc_data %>% inner_join(loyalty_data,
                                          by=c('location','price','date'))
sum_by_location <- joint_cc_loyalty %>%
select(location, price) %>%
group_by(location) %>%
summarise(total_price = sum(price), total_count = n()) %>%
arrange(desc(total_count), desc(total_price))

colnames(joint_cc_loyalty)[1] <- "timestamp"

new_cc_data <- merge(cc_data, joint_cc_loyalty,
                              by=c('timestamp','location','price','last4ccnum'),all=TRUE)
          
new_loyalty_data <- merge(loyalty_data, joint_cc_loyalty,
                          by.x=c('timestamp','location','price','loyaltynum'),
                          by.y =c('timestamp.y','location','price','loyaltynum'),
                          all=TRUE)

new_cc_data <-new_cc_data[!((new_cc_data$last4ccnum =="4795" & new_cc_data$loyaltynum =="L2070") | (new_cc_data$last4ccnum =="4948" & new_cc_data$loyaltynum =="L3295") | (new_cc_data$last4ccnum =="5368" & new_cc_data$loyaltynum =="L6119") | (new_cc_data$last4ccnum =="5921" & new_cc_data$loyaltynum =="L2247") | (new_cc_data$last4ccnum =="8332" & new_cc_data$loyaltynum =="L8566") |
(new_cc_data$last4ccnum =="7889" & new_cc_data$loyaltynum =="L2247")),] %>%
  select(timestamp,location, price,last4ccnum,date.x,loyaltynum)


glimpse(new_cc_data)
```

3. Mapping the credit card and loyalty card based on the transactions with same location, transaction timestamp and price.

```{r}
cards_mapping <- new_cc_data %>%
select(last4ccnum,loyaltynum) %>%
filter(loyaltynum>0) %>%
group_by(last4ccnum,loyaltynum) %>%
summarise(total_count = n()) %>%
arrange(desc(total_count))

duplicates_update <- cards_mapping %>%
  group_by(last4ccnum) %>%
  summarise(no_count=n())


```



3. Create new data frame to show the summarized price and frequency for locations for both 
credit card data and loyalty data to compare whether they can match.

For credit card data:

```{r}
sum_cc_data <- cc_data %>%
select(location, price) %>%
group_by(location) %>%
summarise(total_price = sum(price), total_count = n()) %>%
arrange(desc(total_count), desc(total_price))

glimpse(sum_cc_data)
```
For loyalty card data:

```{r}
sum_loyalty_data <- loyalty_data %>%
select(location, price) %>%
group_by(location) %>%
summarise(total_price = sum(price), total_count = n()) %>%
arrange(desc(total_count), desc(total_price))

glimpse(sum_loyalty_data)
```




# 4. Proposed visualisation

### 4.1 Most popular location

we identify the most popular location based on shopping frequency and the amount of money spent. Katerina’s Café is the place people go and visit most. Also, Abila Airport is the place people spent most.

```{r}
ggplot(sum_by_location, aes(x = location)) +
  geom_col(aes( y = total_count, fill="steelblue")) +
  geom_line(aes(y = total_price/500, group = 1, color = 'orange')) +
  geom_point(aes(x=location, y=sum_by_location$total_price/500, color="orange"))+
  scale_y_continuous(name = "Frequency", sec.axis = sec_axis(trans = ~ .* 500,name = "Price")) +
  scale_fill_manual('', labels = 'Frequency', values = "steelblue") +
  scale_color_manual('', labels = 'Total Price', values = 'orange') +
  theme(axis.text.x = element_text(angle = 90),legend.position="bottom")
```
### 4.2 Most popular timeslot

Based on the most popular location, we explore the most popular time people visit in 24 hours each day using heatmap graph, the darker the color is, the more popular the place is in this timeslot.

So, for Katerina’s Café, most of people go there around 13pm to 15pm and 19pm to 21pm each day.

```{r}
popular_time <- joint_cc_loyalty %>%
  select(location,date,timestamp,price) %>%
  filter(location == "Katerina’s Café"|location == "Abila Airport") 

popular_time$hour <- hour(popular_time$timestamp)

popular_time_count <- popular_time %>%
  group_by(location,date,hour) %>%
  summarise(frequency = n())

popular_time_count <- popular_time_count %>%
  right_join(expand.grid(location = unique(popular_time$location),
                       date = unique(popular_time$date),
                       hour = c(1:23)),
             by =c('location','date','hour')) %>%
  replace_na(list(frequency = 0L))

ggplot(popular_time_count,aes(date, hour, fill= frequency)) + 
geom_tile(color = 'white',size = 0.1) + 
  facet_grid(~location) +
   scale_fill_distiller(palette = "orange",direction = 1)+
  scale_x_date(breaks = popular_time_count$date[seq(1, length(popular_time_count$date), by = 2)])+
  scale_y_continuous(breaks = seq(1,24,2)) +
  theme(axis.text.x = element_text(angle = 90),legend.position="bottom")
```



for cc_data:

```{r}
ggplot(sum_cc_data, aes(x = location)) +
  geom_col(aes( y = total_count, fill="steelblue")) +
  geom_line(aes(y = total_price/500, group = 1, color = 'orange')) +
  geom_point(aes(x=location, y=sum_cc_data$total_price/500, color="orange"))+
  scale_y_continuous(name = "Frequency", sec.axis = sec_axis(trans = ~ .* 500,name = "Price")) +
  scale_fill_manual('', labels = 'Frequency', values = "steelblue") +
  scale_color_manual('', labels = 'Total Price', values = 'orange') +
  theme(axis.text.x = element_text(angle = 90),legend.position="bottom")
```


for loyalty_data:
```{r}
ggplot(sum_loyalty_data, aes(x = location)) +
  geom_col(aes( y = total_count, fill="steelblue")) +
  geom_line(aes(y = total_price/500, group = 1, color = 'orange')) +
  geom_point(aes(x=location, y=sum_loyalty_data$total_price/500, color="orange"))+
  scale_y_continuous(name = "Frequency", sec.axis = sec_axis(trans = ~ .* 500,name = "Price")) +
  scale_fill_manual('', labels = 'Frequency', values = "steelblue") +
  scale_color_manual('', labels = 'Total Price', values = 'orange') +
  theme(axis.text.x = element_text(angle = 90),legend.position="bottom")
```


# 5. Insights

### 5.1 Anomalies about credit card and loyalty data

As loyalty cards data is always generated from credit cards data, both the data should be same by right. However, the some transactions data in credit card dataset are not consistent with the data in loyalty dataset. There are 1490 and 1392 transactions in credit card dataset and loyalty dataset respectively. Also, just 1087 transactions can match based on the location, timestamp and price spent for each transaction.









